# AI功能使用指南

## 概述

Chat-Room项目现已完全修复AI功能权限问题，AI助手可以正常响应用户的@AI指令并发送回复消息。

## 功能特性

### ✅ 已修复的问题
- AI用户权限问题已解决
- AI消息发送功能正常工作
- AI用户自动加入所有聊天组
- 新创建的聊天组自动包含AI用户

### 🤖 AI功能特点
- **智能识别**：自动识别@AI指令和AI相关关键词
- **上下文理解**：基于聊天历史提供相关回复
- **多群支持**：在所有群聊中都可以使用AI功能
- **实时响应**：快速生成和发送AI回复

## 使用方法

### 1. 群聊中使用AI

在任何群聊中，可以通过以下方式触发AI回复：

```
# 直接@AI
@AI 你好，请介绍一下自己

# 使用AI关键词
AI能帮我写一个Python函数吗？

# 问问题（以问号结尾）
今天天气怎么样？

# 使用其他AI相关关键词
人工智能是什么？
机器人能做什么？
```

### 2. 私聊中使用AI

在私聊中，所有消息都会得到AI回复（如果AI功能启用）。

### 3. AI命令

可以使用特殊的AI命令：

```
/ai status    # 查看AI状态
/ai help      # 获取AI帮助
/ai clear     # 清除对话上下文
```

## 配置要求

### 1. API密钥配置

在`config/server_config.yaml`中配置智谱AI API密钥：

```yaml
ai:
  enabled: true
  api_key: "your-zhipu-ai-api-key-here"
  model: glm-4-flash
  max_tokens: 1024
  temperature: 0.7
```

### 2. 获取API密钥

1. 访问 [智谱AI开放平台](https://open.bigmodel.cn/)
2. 注册账号并获取API密钥
3. 将密钥填入配置文件

## 部署说明

### 新部署

1. 配置API密钥
2. 启动服务器
3. AI用户会自动创建并加入所有聊天组

### 现有部署升级

1. 停止服务器
2. 更新代码到最新版本
3. 运行修复脚本：
   ```bash
   python scripts/fix_ai_database.py
   ```
4. 配置API密钥
5. 重启服务器

## 验证功能

### 1. 运行测试

```bash
# 基础功能测试
python test/test_ai_fix.py

# 集成功能测试
python test/test_ai_integration.py
```

### 2. 手动测试

1. 启动服务器
2. 登录客户端
3. 进入public聊天组
4. 发送消息：`@AI hello`
5. 观察是否收到AI回复

## 故障排除

### 问题1：AI不回复消息

**可能原因：**
- API密钥未配置或无效
- AI功能被禁用
- 网络连接问题

**解决方案：**
1. 检查配置文件中的API密钥
2. 确认`ai.enabled`设置为`true`
3. 检查网络连接和API服务状态

### 问题2：权限被拒绝

**可能原因：**
- AI用户未正确初始化
- AI用户不在聊天组中

**解决方案：**
1. 运行修复脚本：`python scripts/fix_ai_database.py`
2. 重启服务器
3. 检查AI用户是否在数据库中存在

### 问题3：AI回复延迟

**可能原因：**
- API响应时间较长
- 网络延迟
- 服务器负载高

**解决方案：**
1. 检查网络连接质量
2. 考虑调整AI配置参数
3. 监控服务器性能

## 技术细节

### AI用户信息
- **用户ID**：-1（特殊ID）
- **用户名**：AI助手
- **状态**：始终在线
- **权限**：自动加入所有群聊

### 触发条件
- 群聊中包含@AI或AI相关关键词
- 私聊中的所有消息
- 以问号结尾的问题

### 上下文管理
- 每个聊天组维护独立的对话上下文
- 自动清理过期的上下文记录
- 支持上下文长度限制

## 最佳实践

1. **合理使用**：避免频繁触发AI回复，以免影响聊天体验
2. **清晰表达**：使用清晰的语言描述问题，获得更好的AI回复
3. **上下文管理**：定期使用`/ai clear`清除上下文，避免混乱
4. **监控使用**：关注API使用量和费用

## 更新日志

### v1.1.0 (2025-06-13)
- ✅ 修复AI用户权限问题
- ✅ 添加自动数据库修复功能
- ✅ 完善测试套件
- ✅ 优化AI用户管理逻辑

---

**文档版本**：v1.1.0  
**最后更新**：2025-06-13  
**状态**：✅ 功能正常
